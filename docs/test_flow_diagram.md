# 測試流程圖解 (Test Flow Diagram)

## 整體測試架構 (Overall Test Architecture)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         真實數據來源 (Real Data Source)                       │
│  /Users/maple/github/LuminNexus-AtlasVault-Vault/data/iherb/catalog/      │
│                                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                    │
│  │ 100627.json  │  │ 150817.json  │  │ 88865.json   │  ... 50,461 files  │
│  │              │  │              │  │              │                     │
│  │ • description│  │ • description│  │ • description│                     │
│  │ • suggested  │  │ • ingredients│  │ • suggested  │                     │
│  │ • supplement │  │ • suggested  │  │ • warnings   │                     │
│  └──────────────┘  └──────────────┘  └──────────────┘                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ 隨機選取 2 個產品
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    測試數據固件 (Test Fixtures)                               │
│                 tests/fixtures/iherb_sample_data.py                         │
│                                                                             │
│  PRODUCT_100627_DESCRIPTION = """<ul><li>Immune System</li>..."""          │
│  PRODUCT_100627_SUPPLEMENT_FACTS = """<table>..."""                        │
│  PRODUCT_150817_INGREDIENTS = """<table><tr><td>Drug Facts...</table>"""   │
│                                                                             │
│  TEST_CASES = [                                                             │
│    {                                                                        │
│      "id": "100627",                                                        │
│      "test_scenarios": [...]                                                │
│    }                                                                        │
│  ]                                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 測試執行流程 (Test Execution Flow)

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         pytest 執行測試                                       │
│                  tests/test_real_world_conversions.py                        │
└──────────────────────────────────────────────────────────────────────────────┘
                                   │
                    ┌──────────────┴──────────────┐
                    │                             │
                    ▼                             ▼
    ┌───────────────────────────┐   ┌────────────────────────────┐
    │  測試 HTML → Markdown     │   │  測試 HTML → ASCII Table   │
    │                           │   │                            │
    │  test_product_100627_     │   │  test_product_100627_      │
    │    description_conversion │   │    supplement_facts_table  │
    └───────────────────────────┘   └────────────────────────────┘
                    │                             │
                    └──────────────┬──────────────┘
                                   ▼
```

## 單一測試案例詳細流程 (Single Test Case Detail)

```
測試案例: product_100627_description (HTML → Markdown)

┌─────────────────────────────────────────────────────────────────────────────┐
│ 步驟 1: 輸入 HTML                                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  INPUT_HTML = """                                                           │
│  <ul>                                                                       │
│    <li>Immune System</li>                                                  │
│    <li>No Artificial Flavors or Preservatives</li>                         │
│    <li>Colostrum, Gut Health Blend, &amp; Salmon Oil</li>                  │
│  </ul>                                                                      │
│  <p><strong>Paw-erful Support for Fido's Immune System!</strong></p>       │
│  <p>Senior Advanced Allergy Immune Bites offers extra TLC...</p>           │
│  """                                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ 呼叫轉換函數
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 步驟 2: 轉換處理                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  from luminnexus_alchemy_shared.html import convert_html_to_markdown        │
│                                                                             │
│  result = convert_html_to_markdown(INPUT_HTML)                              │
│                                                                             │
│  內部處理:                                                                   │
│    1. BeautifulSoup 解析 HTML                                               │
│    2. 處理列表 (<ul> → - )                                                  │
│    3. 處理粗體 (<strong> → **)                                              │
│    4. 處理 HTML 實體 (&amp; → &)                                            │
│    5. 清理和格式化                                                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ 產生輸出
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 步驟 3: 輸出 Markdown                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  OUTPUT_MARKDOWN = """                                                      │
│  - Immune System                                                            │
│  - No Artificial Flavors or Preservatives                                  │
│  - Colostrum, Gut Health Blend, & Salmon Oil                               │
│                                                                             │
│  **Paw-erful Support for Fido's Immune System!**                           │
│                                                                             │
│  Senior Advanced Allergy Immune Bites offers extra TLC...                  │
│  """                                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                    ┌──────────────┴──────────────┐
                    │                             │
                    ▼                             ▼
    ┌──────────────────────────┐    ┌────────────────────────────┐
    │ 步驟 4a: 基本斷言檢查    │    │ 步驟 4b: 準備 LLM 驗證     │
    │                          │    │                            │
    │ assert result is not None│    │ 收集驗證數據:              │
    │ assert "Immune" in result│    │                            │
    │ assert "**" in result    │    │ • 原始 HTML                │
    │ assert "&amp;" not in    │    │ • 轉換結果                 │
    │        result            │    │ • 驗證標準                 │
    │                          │    │                            │
    │ ✅ PASS                  │    │ 等待 LLM 驗證...           │
    └──────────────────────────┘    └────────────────────────────┘
```

## LLM 驗證流程 (LLM Validation Flow)

```
步驟 5: LLM 驗證 (使用 Claude Code Command)

┌─────────────────────────────────────────────────────────────────────────────┐
│ 執行驗證指令:                                                                │
│                                                                             │
│   /validate-conversion                                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ LLM Agent 接收數據並評估                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  輸入給 LLM:                                                                 │
│  ┌───────────────────────────────────────────────────────────────────┐    │
│  │ 原始 HTML:                                                         │    │
│  │   <ul><li>Immune System</li>...</ul>                              │    │
│  │                                                                    │    │
│  │ 轉換結果:                                                           │    │
│  │   - Immune System                                                  │    │
│  │   - No Artificial Flavors...                                       │    │
│  │                                                                    │    │
│  │ 驗證標準:                                                           │    │
│  │   ✓ 列表項目轉換正確                                                │    │
│  │   ✓ 粗體文字保留 (**text**)                                         │    │
│  │   ✓ HTML 實體處理 (&amp; → &)                                       │    │
│  │   ✓ 段落結構保持                                                    │    │
│  │   ✓ ® 商標符號保留                                                  │    │
│  └───────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  LLM 評估維度:                                                               │
│  ┌─────────────────────────────────────────────────────────────┐          │
│  │ 1. 信息完整性 (30%)                                          │          │
│  │    ├─ 所有文字內容都在嗎？         ✅ 100%                   │          │
│  │    ├─ 格式提示保留了嗎？           ✅ 100%                   │          │
│  │    └─ 鏈接保留了嗎？               N/A                       │          │
│  │                                                              │          │
│  │ 2. 可讀性 (30%)                                              │          │
│  │    ├─ 適當的空行和間距？           ✅ 優秀                    │          │
│  │    ├─ 清晰的層次結構？             ✅ 優秀                    │          │
│  │    └─ 易於瀏覽掃讀？               ✅ 優秀                    │          │
│  │                                                              │          │
│  │ 3. Markdown 標準 (25%)                                       │          │
│  │    ├─ 正確的列表語法？             ✅ 是                      │          │
│  │    ├─ 標題標記正確？               ✅ 是                      │          │
│  │    └─ 適當的轉義？                 ✅ 是                      │          │
│  │                                                              │          │
│  │ 4. 邊界情況處理 (15%)                                        │          │
│  │    ├─ HTML 實體解碼？              ✅ 正確                    │          │
│  │    ├─ 特殊字符保留？               ✅ 正確                    │          │
│  │    └─ 空元素處理？                 ✅ 正確                    │          │
│  └─────────────────────────────────────────────────────────────┘          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ 生成評估結果
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ LLM 輸出評估報告                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐      │
│  │ ✅ PASS - product_100627_description                            │      │
│  │                                                                  │      │
│  │ Score: 0.92 / 1.0                                                │      │
│  │                                                                  │      │
│  │ 整體評價:                                                         │      │
│  │ 這是一個優秀的轉換。所有內容都被正確保留，格式清晰易讀。       │      │
│  │ Markdown 語法標準，沒有發現重大問題。                            │      │
│  │                                                                  │      │
│  │ ✨ 優點:                                                         │      │
│  │   • 列表項目完美轉換為 Markdown 格式                            │      │
│  │   • HTML 實體 (&amp;) 正確解碼為 &                              │      │
│  │   • 粗體標記 (**) 使用正確                                       │      │
│  │   • 段落之間有適當的空行分隔                                     │      │
│  │   • 商標符號 (®) 完整保留                                        │      │
│  │                                                                  │      │
│  │ ⚠️  需要改進:                                                    │      │
│  │   • 某些項目符號後的空格稍微不一致                               │      │
│  │   • 可以考慮為產品名稱添加標題標記 (##)                          │      │
│  │                                                                  │      │
│  │ 建議: 轉換品質高，可用於生產環境。小問題不影響整體可用性。      │      │
│  └─────────────────────────────────────────────────────────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 表格轉換案例 (Table Conversion Example)

```
測試案例: product_100627_supplement_facts (HTML Table → ASCII Table)

┌─────────────────────────────────────────────────────────────────────────────┐
│ 輸入: HTML 表格                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  <table border="1">                                                         │
│    <tr><td colspan="2"><strong>Product Facts</strong></td></tr>             │
│    <tr><td>Salmon Oil</td><td>400 mg</td></tr>                              │
│    <tr><td>Quercetin Dihydrate</td><td>340 mg</td></tr>                     │
│    <tr><td>Vitamin C (Ascorbic Acid)</td><td>50 mg</td></tr>                │
│  </table>                                                                   │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 轉換: convert_html_to_table()                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 輸出: Rich ASCII 表格                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────────────────────┬──────────┐                                 │
│  │ Product Facts              │          │                                 │
│  ├────────────────────────────┼──────────┤                                 │
│  │ Salmon Oil                 │ 400 mg   │                                 │
│  ├────────────────────────────┼──────────┤                                 │
│  │ Quercetin Dihydrate        │ 340 mg   │                                 │
│  ├────────────────────────────┼──────────┤                                 │
│  │ Vitamin C (Ascorbic Acid)  │ 50 mg    │                                 │
│  └────────────────────────────┴──────────┘                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ LLM 評估表格品質                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  檢查項目:                                                                   │
│  ┌───────────────────────────────────────────────┐                         │
│  │ 1. 數據完整性 (35%)                           │                         │
│  │    ├─ 所有成分名稱都在？    ✅ 是             │                         │
│  │    ├─ 所有數量正確？        ✅ 是 (400mg等)   │                         │
│  │    └─ 單位保留？            ✅ 是 (mg)        │                         │
│  │                                                │                         │
│  │ 2. 結構清晰度 (25%)                           │                         │
│  │    ├─ 表格邊框可見？        ✅ 清晰           │                         │
│  │    ├─ 標題區分明顯？        ✅ 是             │                         │
│  │    └─ 行列對齊？            ✅ 完美對齊       │                         │
│  │                                                │                         │
│  │ 3. 可讀性 (25%)                                │                         │
│  │    ├─ 欄位對齊？            ✅ 左對齊         │                         │
│  │    ├─ 寬度合理？            ✅ 適中           │                         │
│  │    └─ 文字未被截斷？        ✅ 完整           │                         │
│  │                                                │                         │
│  │ 4. 邊界處理 (15%)                             │                         │
│  │    ├─ Colspan 處理？        ✅ 正確合併       │                         │
│  │    ├─ 巢狀 HTML 提取？      ✅ 正確           │                         │
│  │    └─ 空單元格顯示？        N/A               │                         │
│  └───────────────────────────────────────────────┘                         │
│                                                                             │
│  Score: 0.95 / 1.0                                                          │
│  ✅ PASS - 表格轉換優秀                                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 完整測試報告範例 (Complete Test Report Example)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         HTML 轉換驗證報告                                    │
│                      Generated: 2025-11-17                                  │
└─────────────────────────────────────────────────────────────────────────────┘

測試總數: 6
通過: 5 / 6 (83%)
平均分數: 0.87 / 1.0

══════════════════════════════════════════════════════════════════════════════

✅ PASS | product_100627_description (Score: 0.92)
   優點: 列表轉換完美、HTML實體正確解碼
   問題: 空格稍微不一致

✅ PASS | product_100627_suggested_use (Score: 0.88)
   優點: 表格結構清晰、內容完整
   問題: 表格對齊可以更好

✅ PASS | product_100627_supplement_facts (Score: 0.95)
   優點: 數據完整、視覺效果優秀
   問題: 無

✅ PASS | product_150817_description (Score: 0.90)
   優點: 簡潔明瞭、格式標準
   問題: 無

❌ FAIL | product_150817_ingredients (Score: 0.68)
   優點: 基本結構正確
   問題: 長成分列表未正確換行、colspan處理有誤

✅ PASS | product_150817_suggested_use (Score: 0.85)
   優點: 段落清晰、內容完整
   問題: 時間格式可以更標準化

══════════════════════════════════════════════════════════════════════════════

總體建議:
• 表格處理需要改進 colspan 和長文字換行
• HTML to Markdown 整體品質良好
• 建議優先修復 ingredients 表格的問題

══════════════════════════════════════════════════════════════════════════════
```
